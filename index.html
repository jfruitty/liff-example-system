<!DOCTYPE html>
<html>

<head>
  <script src="https://static.line-scdn.net/liff/edge/versions/2.13.0/sdk.js"></script>
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <label for="description">คำอธิบายอาการ</label><br>
  <textarea id="description" name="description" rows="4" cols="50"></textarea><br><br>
  <label for="image">รูปภาพประกอบ:</label><br>
  <input type="file" id="image" name="image"><br><br>
  <button id="submitButton">Submit</button>

  <script>

    liff.init({ liffId: "2000454945-mEl8eZP8" }, () => {
      if (liff.isLoggedIn()) {
        const idToken = liff.getDecodedIDToken();
        console.log(idToken);
        const profile = liff.getProfile();
        console.log(profile);

        runApp();


      } else {
        liff.login();

      }
    }).catch((err) => {
      // Error happens during initialization
      console.log(err.code, err.message);
    });

async function uploadFileToDrive(fileBlob, folderName, fileName) {
  const apiUrl = "https://script.google.com/macros/s/AKfycbysUOlE5LYTnffqlGCLOW-7L3ArcSEL8WWhO8Sf8OszxY-4eNroEX61TdQ9ghpxXU6W/exec"; // Replace with your script URL
  
  const requestData = {
    fileBlob: fileBlob,
    folderName: folderName,
    fileName: fileName
  };

  try {
    const response = await fetch(apiUrl, {
      method: "POST",
      body: JSON.stringify(requestData),
      headers: {
        "Content-Type": "application/json"
      },
      mode: "no-cors" // Use no-cors mode
    });

    if (response.ok) {
      const data = await response.json();
      onSuccess(data.fileUrl);
      if (data.success) {
        console.log("File uploaded successfully. File URL:", data.fileUrl);
      } else {
        console.error("File upload failed:", data.message);
      }
    } else {
      console.error("Request failed:", response.status, response.statusText);
    }
  } catch (error) {
    console.error("An error occurred:", error);
  }
}

async function sendDataToScript(userId, displayName, description, imageUrl) {
  const apiUrl = "https://script.google.com/macros/s/AKfycbysUOlE5LYTnffqlGCLOW-7L3ArcSEL8WWhO8Sf8OszxY-4eNroEX61TdQ9ghpxXU6W/exec"; // Replace with your script URL

  const requestData = {
    userId: userId,
    displayName: displayName,
    description: description,
    imageUrl: imageUrl
  };

  try {
    const response = await fetch(apiUrl, {
      method: "POST",
      body: JSON.stringify(requestData),
      headers: {
        "Content-Type": "application/json"
      },
      mode: "no-cors" // Use no-cors mode
    });

    if (response.ok) {
      const data = await response.json();
      if (data.success) {
        console.log("Data sent successfully:", data.message);
      } else {
        console.error("Sending data failed:", data.message);
      }
    } else {
      console.error("Request failed:", response.status, response.statusText);
    }
  } catch (error) {
    console.error("An error occurred:", error);
  }
}

    function runApp() {
      document.getElementById("submitButton").addEventListener("click", function () {
        var description = document.getElementById("description").value;
        var image = document.getElementById("image").files[0];
        var profile = liff.getProfile();


        var userId = profile.userId;

        var displayName = profile.displayName;

        if (description && image) {

          alert("ระบบใช้เวลาบันทึกสักครู่ โปรดอย่าปิดหน้าต่าง");

          const fr = new FileReader();

          fr.onload = function (e) {
            const fileBlob = {
              filename: image.name,
              mimeType: image.type,
              bytes: [...new Int8Array(e.target.result)]
            };

            const folderName = "CustomerImages";
            const fileName = fileBlob.filename;

            uploadFileToDrive(fileBlob, folderName, fileName);

          };

          fr.readAsArrayBuffer(image);

          function onSuccess(url) {
           
            sendDataToScript(userId, displayName, description, imageUrl);
            alert("Form submitted successfully!");
          }
        } else {
          alert("Please provide both description and image.");

        }
      });

    }




  </script>
</body>

</html>